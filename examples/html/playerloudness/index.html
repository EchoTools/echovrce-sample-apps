<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EchoVRCE Loudness Lookup</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        background-color: #121212;
        color: #e0e0e0;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 2rem;
      }
      .container {
        width: 100%;
        max-width: 600px;
        background-color: #1e1e1e;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      }
      h1 {
        margin-top: 0;
        color: #bb86fc;
      }
      .input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      input {
        flex: 1;
        padding: 10px;
        border-radius: 4px;
        border: 1px solid #333;
        background-color: #2c2c2c;
        color: #fff;
        font-size: 1rem;
      }
      button {
        padding: 10px 20px;
        background-color: #bb86fc;
        color: #000;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        font-size: 1rem;
      }
      button:hover {
        background-color: #9965f4;
      }
      .error {
        color: #cf6679;
        margin-top: 10px;
        display: none;
      }
      .result-card {
        background-color: #2c2c2c;
        padding: 15px;
        border-radius: 4px;
        margin-top: 20px;
        display: none;
      }
      .result-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #3e3e3e;
      }
      .result-row:last-child {
        border-bottom: none;
      }
      .label {
        color: #9e9e9e;
        font-size: 0.9rem;
      }
      .value {
        font-family: monospace;
        color: #03dac6;
      }
      .highlight {
        color: #bb86fc;
        font-weight: bold;
      }
      pre {
        background: #000;
        padding: 10px;
        overflow-x: auto;
        font-size: 0.8rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Player Loudness Lookup</h1>
      <div class="input-group">
        <input
          type="text"
          id="searchInput"
          placeholder="Enter Username, Discord ID, or UUID"
        />
        <button onclick="handleSearch()">Lookup</button>
      </div>
      <div id="errorMsg" class="error"></div>

      <div id="results" class="result-card">
        <h3>Account Details</h3>
        <div class="result-row">
          <span class="label">Display Name</span>
          <span class="value" id="resDisplayName"></span>
        </div>
        <div class="result-row">
          <span class="label">Username</span>
          <span class="value" id="resUsername"></span>
        </div>
        <div class="result-row">
          <span class="label">Discord ID</span>
          <span class="value" id="resDiscordId"></span>
        </div>
        <div class="result-row">
          <span class="label">User ID (UUID)</span>
          <span class="value" id="resUserId"></span>
        </div>

        <h3>Loudness Stats</h3>
        <div class="result-row">
          <span class="label">Min Loudness</span>
          <span class="value highlight" id="resMinLoudness"></span>
        </div>
        <div class="result-row">
          <span class="label">Max Loudness</span>
          <span class="value highlight" id="resMaxLoudness"></span>
        </div>
        <div class="result-row">
          <span class="label">Rank</span>
          <span class="value" id="resRank"></span>
        </div>
        <div class="result-row">
          <span class="label">Count</span>
          <span class="value" id="resCount"></span>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = "https://g.echovrce.com";

      function checkHash() {
        if (window.location.hash) {
          const hashVal = decodeURIComponent(window.location.hash.substring(1));
          if (
            hashVal &&
            document.getElementById("searchInput").value !== hashVal
          ) {
            document.getElementById("searchInput").value = hashVal;
            handleSearch();
          }
        }
      }

      window.addEventListener("DOMContentLoaded", checkHash);
      window.addEventListener("hashchange", checkHash);

      async function handleSearch() {
        const input = document.getElementById("searchInput").value.trim();

        if (input) {
          const encoded = encodeURIComponent(input);
          if (window.location.hash.substring(1) !== encoded) {
            window.location.hash = encoded;
          }
        }

        const errorDiv = document.getElementById("errorMsg");
        const resultDiv = document.getElementById("results");

        errorDiv.style.display = "none";
        errorDiv.textContent = "";
        resultDiv.style.display = "none";

        if (!input) return;

        try {
          // 1. Determine Input Type
          let paramKey = "username";
          const uuidRegex =
            /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
          const discordRegex = /^\d{17,19}$/;

          if (uuidRegex.test(input)) {
            paramKey = "user_id";
          } else if (discordRegex.test(input)) {
            paramKey = "discord_id";
          }

          // 2. Account Lookup
          const lookupUrl = `${API_BASE}/account/lookup?${paramKey}=${encodeURIComponent(
            input
          )}`;
          const accountRes = await fetch(lookupUrl);

          if (!accountRes.ok)
            throw new Error(`Account lookup failed: ${accountRes.status}`);
          const accountData = await accountRes.json();

          if (!accountData || !accountData.id)
            throw new Error("User not found.");

          // 3. Leaderboard Lookup
          // Using 'owner_id' as requested in the prompt logic, mapped to the account 'id'
          const lbParams = new URLSearchParams({
            guild_id: "779349159852769310",
            game_mode: "social_2.0",
            stat_name: "PlayerLoudness",
            reset_schedule: "daily",
            limit: "100",
            from_rank: "1",
            owner_id: accountData.id,
          });

          const lbUrl = `${API_BASE}/leaderboard/haystack?${lbParams.toString()}`;
          const lbRes = await fetch(lbUrl);

          if (!lbRes.ok)
            throw new Error(`Leaderboard lookup failed: ${lbRes.status}`);
          const lbData = await lbRes.json();

          // 4. Find specific user record in haystack
          // Haystack returns a list of neighbors; we must filter for our specific owner_id
          // The API might return 'records' or 'entries' depending on the endpoint version/type
          const entries = Array.isArray(lbData)
            ? lbData
            : lbData.records || lbData.entries || [];
          console.log("Leaderboard Entries:", entries);

          const userStat = entries.find(
            (entry) =>
              (entry.owner_id && entry.owner_id == accountData.id) ||
              (entry.user_id && entry.user_id == accountData.id)
          );

          if (!userStat)
            throw new Error("User found, but no loudness stats available.");

          // 5. Render
          document.getElementById("resDisplayName").textContent =
            userStat.display_name || accountData.display_name || "N/A";
          document.getElementById("resUsername").textContent =
            accountData.username || "N/A";
          document.getElementById("resDiscordId").textContent =
            accountData.discord_id || "N/A";
          document.getElementById("resUserId").textContent =
            accountData.id || "N/A";

          const fmt = (v) => {
            const n = parseFloat(v);
            return isNaN(n) ? "N/A" : n.toFixed(1) + " dB";
          };

          document.getElementById("resMinLoudness").textContent = fmt(
            userStat.metadata?.min_loudness
          );
          document.getElementById("resMaxLoudness").textContent = fmt(
            userStat.metadata?.max_loudness
          );

          document.getElementById("resRank").textContent =
            userStat.rank || "N/A";
          document.getElementById("resCount").textContent =
            userStat.metadata?.count || "N/A";

          resultDiv.style.display = "block";
        } catch (err) {
          console.error(err);
          errorDiv.textContent = err.message;
          errorDiv.style.display = "block";
        }
      }
    </script>
  </body>
</html>

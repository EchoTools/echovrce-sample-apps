<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Echo VR Match Viewer</title>
    <link rel="stylesheet" href="../shared/theme/colors.css" />
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: var(--bg-primary, #1a1a2e);
        color: var(--text-primary, #fff);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .header {
        background: var(--bg-secondary, #16213e);
        padding: 1rem 2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid var(--border-color, #0f3460);
      }

      .header h1 {
        font-size: 1.5rem;
        font-weight: 600;
      }

      .controls {
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .control-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      input,
      select,
      button {
        padding: 0.5rem 1rem;
        border: 1px solid var(--border-color, #0f3460);
        border-radius: 4px;
        background: var(--bg-primary, #1a1a2e);
        color: var(--text-primary, #fff);
        font-size: 0.9rem;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: var(--accent-color, #e94560);
      }

      button {
        cursor: pointer;
        background: var(--accent-color, #e94560);
        border-color: var(--accent-color, #e94560);
        transition: opacity 0.2s;
      }

      button:hover {
        opacity: 0.9;
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .main-content {
        flex: 1;
        display: flex;
        padding: 1rem;
        gap: 1rem;
      }

      .minimap-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
      }

      .minimap-wrapper {
        position: relative;
        max-width: 800px;
        width: 100%;
      }

      .minimap {
        width: 100%;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      }

      .player-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }

      .player-dot {
        position: absolute;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: bold;
        color: white;
        transform: translate(-50%, -50%);
        transition: all 0.05s linear;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .player-dot.blue {
        background: #3b82f6;
      }

      .player-dot.orange {
        background: #f97316;
      }

      .player-dot.spectator {
        background: #6b7280;
      }

      .disc-dot {
        position: absolute;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #fbbf24;
        border: 2px solid white;
        transform: translate(-50%, -50%);
        transition: all 0.05s linear;
      }

      .sidebar {
        width: 300px;
        background: var(--bg-secondary, #16213e);
        border-radius: 8px;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .match-info {
        padding: 1rem;
        background: var(--bg-tertiary, #0f3460);
        border-radius: 4px;
      }

      .match-info h3 {
        margin-bottom: 0.5rem;
        font-size: 1rem;
      }

      .score-display {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 2rem;
        padding: 1rem;
        background: var(--bg-tertiary, #0f3460);
        border-radius: 4px;
      }

      .team-score {
        text-align: center;
      }

      .team-score .team-name {
        font-size: 0.9rem;
        opacity: 0.8;
      }

      .team-score .score {
        font-size: 2.5rem;
        font-weight: bold;
      }

      .team-score.blue .score {
        color: #3b82f6;
      }

      .team-score.orange .score {
        color: #f97316;
      }

      .clock {
        font-size: 1.5rem;
        font-weight: bold;
        text-align: center;
      }

      .player-list {
        flex: 1;
        overflow-y: auto;
      }

      .player-list h4 {
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        opacity: 0.8;
      }

      .player-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        border-radius: 4px;
        margin-bottom: 0.25rem;
      }

      .player-item.blue {
        background: rgba(59, 130, 246, 0.2);
      }

      .player-item.orange {
        background: rgba(249, 115, 22, 0.2);
      }

      .player-jersey {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: bold;
        color: white;
      }

      .player-jersey.blue {
        background: #3b82f6;
      }

      .player-jersey.orange {
        background: #f97316;
      }

      .playback-controls {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: var(--bg-secondary, #16213e);
        border-radius: 8px;
      }

      .playback-controls button {
        padding: 0.5rem;
        width: 40px;
        height: 40px;
      }

      .seek-slider {
        flex: 1;
        -webkit-appearance: none;
        height: 4px;
        border-radius: 2px;
        background: var(--bg-tertiary, #0f3460);
      }

      .seek-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: var(--accent-color, #e94560);
        cursor: pointer;
      }

      .status-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
      }

      .status-dot.connected {
        background: #22c55e;
      }

      .status-dot.disconnected {
        background: #ef4444;
      }

      .status-dot.connecting {
        background: #f59e0b;
        animation: pulse 1s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
    </style>
  </head>
  <body>
    <header class="header">
      <h1>üèüÔ∏è Echo VR Match Viewer</h1>
      <div class="controls">
        <div class="control-group">
          <label for="server-url">Server:</label>
          <input
            type="text"
            id="server-url"
            value="ws://localhost:8081"
            placeholder="WebSocket URL"
          />
        </div>
        <div class="control-group">
          <label for="match-id">Match ID:</label>
          <input type="text" id="match-id" placeholder="Enter match ID" />
        </div>
        <div class="control-group">
          <label for="fps">FPS:</label>
          <select id="fps">
            <option value="10">10</option>
            <option value="15">15</option>
            <option value="30" selected>30</option>
            <option value="60">60</option>
          </select>
        </div>
        <button id="connect-btn">Connect</button>
        <div class="status-indicator">
          <span class="status-dot disconnected" id="status-dot"></span>
          <span id="status-text">Disconnected</span>
        </div>
      </div>
    </header>

    <main class="main-content">
      <div class="minimap-container">
        <div class="minimap-wrapper">
          <img
            src="minimap.png"
            alt="Arena Minimap"
            class="minimap"
            id="minimap"
          />
          <svg
            class="player-overlay"
            id="player-overlay"
            viewBox="0 0 100 100"
            preserveAspectRatio="none"
          >
            <!-- Players will be rendered here -->
          </svg>
        </div>

        <div class="playback-controls">
          <button id="play-btn" title="Play/Pause">‚ñ∂</button>
          <input
            type="range"
            class="seek-slider"
            id="seek-slider"
            min="0"
            max="100"
            value="0"
          />
          <span id="frame-counter">Frame: 0</span>
        </div>
      </div>

      <aside class="sidebar">
        <div class="match-info">
          <h3>Match Info</h3>
          <p id="match-type">-</p>
          <p id="game-status">-</p>
        </div>

        <div class="score-display">
          <div class="team-score blue">
            <div class="team-name">Blue</div>
            <div class="score" id="blue-score">0</div>
          </div>
          <div class="clock" id="clock">00:00</div>
          <div class="team-score orange">
            <div class="team-name">Orange</div>
            <div class="score" id="orange-score">0</div>
          </div>
        </div>

        <div class="player-list">
          <h4>Blue Team</h4>
          <div id="blue-players"></div>
          <h4 style="margin-top: 1rem">Orange Team</h4>
          <div id="orange-players"></div>
        </div>
      </aside>
    </main>

    <script>
      // Arena coordinate system mapping
      // The arena is approximately 80m x 30m x 30m
      const ARENA = {
        minX: -40,
        maxX: 40,
        minY: -15,
        maxY: 15,
        minZ: -15,
        maxZ: 15,
      };

      // State
      let ws = null;
      let isPlaying = true;
      let currentFrame = null;

      // DOM Elements
      const elements = {
        serverUrl: document.getElementById("server-url"),
        matchId: document.getElementById("match-id"),
        fps: document.getElementById("fps"),
        connectBtn: document.getElementById("connect-btn"),
        statusDot: document.getElementById("status-dot"),
        statusText: document.getElementById("status-text"),
        playerOverlay: document.getElementById("player-overlay"),
        playBtn: document.getElementById("play-btn"),
        seekSlider: document.getElementById("seek-slider"),
        frameCounter: document.getElementById("frame-counter"),
        matchType: document.getElementById("match-type"),
        gameStatus: document.getElementById("game-status"),
        blueScore: document.getElementById("blue-score"),
        orangeScore: document.getElementById("orange-score"),
        clock: document.getElementById("clock"),
        bluePlayers: document.getElementById("blue-players"),
        orangePlayers: document.getElementById("orange-players"),
      };

      // Connect to WebSocket
      function connect() {
        const serverUrl = elements.serverUrl.value;
        const matchId = elements.matchId.value;
        const fps = elements.fps.value;

        if (!matchId) {
          alert("Please enter a match ID");
          return;
        }

        setStatus("connecting");

        const wsUrl = `${serverUrl}/api/v3/stream/${matchId}?fps=${fps}`;
        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
          setStatus("connected");
          elements.connectBtn.textContent = "Disconnect";
        };

        ws.onclose = () => {
          setStatus("disconnected");
          elements.connectBtn.textContent = "Connect";
          ws = null;
        };

        ws.onerror = (error) => {
          console.error("WebSocket error:", error);
          setStatus("disconnected");
        };

        ws.onmessage = (event) => {
          try {
            const message = JSON.parse(event.data);
            handleMessage(message);
          } catch (e) {
            console.error("Failed to parse message:", e);
          }
        };
      }

      function disconnect() {
        if (ws) {
          ws.close();
          ws = null;
        }
      }

      function setStatus(status) {
        elements.statusDot.className = `status-dot ${status}`;
        elements.statusText.textContent =
          status.charAt(0).toUpperCase() + status.slice(1);
      }

      function handleMessage(message) {
        switch (message.type) {
          case "frame":
            if (isPlaying) {
              updateFrame(message.payload);
            }
            break;
          case "match_ended":
            alert("Match ended");
            break;
          case "stream_ended":
            alert("Stream ended");
            break;
        }
      }

      function updateFrame(frame) {
        currentFrame = frame;

        // Update frame counter
        elements.frameCounter.textContent = `Frame: ${frame.frame_index || 0}`;

        // Update session info
        const session = frame.session || {};
        elements.matchType.textContent = session.match_type || "-";
        elements.gameStatus.textContent = session.game_status || "-";
        elements.blueScore.textContent = session.blue_points || 0;
        elements.orangeScore.textContent = session.orange_points || 0;

        // Update clock
        const clock = session.game_clock || 0;
        const minutes = Math.floor(clock / 60);
        const seconds = Math.floor(clock % 60);
        elements.clock.textContent = `${minutes
          .toString()
          .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;

        // Update players
        renderPlayers(session.teams || []);
      }

      function renderPlayers(teams) {
        // Clear overlay
        elements.playerOverlay.innerHTML = "";
        elements.bluePlayers.innerHTML = "";
        elements.orangePlayers.innerHTML = "";

        teams.forEach((team, teamIndex) => {
          const teamColor = teamIndex === 0 ? "blue" : "orange";
          const playersContainer =
            teamIndex === 0 ? elements.bluePlayers : elements.orangePlayers;

          (team.players || []).forEach((player, playerIndex) => {
            // Calculate position on minimap (using X and Z for top-down view)
            const pos = player.position || [0, 0, 0];
            const x = mapValue(pos[0], ARENA.minX, ARENA.maxX, 0, 100);
            const y = mapValue(pos[2], ARENA.minZ, ARENA.maxZ, 0, 100);

            // Create player dot on minimap
            const circle = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "circle"
            );
            circle.setAttribute("cx", x);
            circle.setAttribute("cy", y);
            circle.setAttribute("r", "2");
            circle.setAttribute(
              "fill",
              teamColor === "blue" ? "#3b82f6" : "#f97316"
            );
            circle.setAttribute("stroke", "white");
            circle.setAttribute("stroke-width", "0.5");
            elements.playerOverlay.appendChild(circle);

            // Add jersey number text
            const text = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "text"
            );
            text.setAttribute("x", x);
            text.setAttribute("y", y + 0.5);
            text.setAttribute("text-anchor", "middle");
            text.setAttribute("dominant-baseline", "middle");
            text.setAttribute("fill", "white");
            text.setAttribute("font-size", "1.5");
            text.setAttribute("font-weight", "bold");
            text.textContent = player.number || playerIndex + 1;
            elements.playerOverlay.appendChild(text);

            // Add to player list
            const playerDiv = document.createElement("div");
            playerDiv.className = `player-item ${teamColor}`;
            playerDiv.innerHTML = `
                        <span class="player-jersey ${teamColor}">${
              player.number || playerIndex + 1
            }</span>
                        <span>${player.name || "Unknown"}</span>
                    `;
            playersContainer.appendChild(playerDiv);
          });
        });

        // Render disc if available
        if (currentFrame && currentFrame.session && currentFrame.session.disc) {
          const discPos = currentFrame.session.disc.position || [0, 0, 0];
          const x = mapValue(discPos[0], ARENA.minX, ARENA.maxX, 0, 100);
          const y = mapValue(discPos[2], ARENA.minZ, ARENA.maxZ, 0, 100);

          const disc = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "circle"
          );
          disc.setAttribute("cx", x);
          disc.setAttribute("cy", y);
          disc.setAttribute("r", "1.5");
          disc.setAttribute("fill", "#fbbf24");
          disc.setAttribute("stroke", "white");
          disc.setAttribute("stroke-width", "0.5");
          elements.playerOverlay.appendChild(disc);
        }
      }

      function mapValue(value, inMin, inMax, outMin, outMax) {
        return ((value - inMin) / (inMax - inMin)) * (outMax - outMin) + outMin;
      }

      // Event Listeners
      elements.connectBtn.addEventListener("click", () => {
        if (ws) {
          disconnect();
        } else {
          connect();
        }
      });

      elements.playBtn.addEventListener("click", () => {
        isPlaying = !isPlaying;
        elements.playBtn.textContent = isPlaying ? "‚è∏" : "‚ñ∂";

        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(
            JSON.stringify({
              type: "control",
              payload: { command: isPlaying ? "play" : "pause" },
            })
          );
        }
      });

      elements.fps.addEventListener("change", () => {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(
            JSON.stringify({
              type: "control",
              payload: {
                command: "framerate",
                framerate: parseInt(elements.fps.value),
              },
            })
          );
        }
      });

      elements.seekSlider.addEventListener("input", () => {
        const frame = parseInt(elements.seekSlider.value);
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(
            JSON.stringify({
              type: "seek",
              payload: { frame: frame },
            })
          );
        }
      });

      // Initialize with disconnected state
      setStatus("disconnected");
    </script>
  </body>
</html>
